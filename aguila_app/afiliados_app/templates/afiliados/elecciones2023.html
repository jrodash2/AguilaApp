{% extends 'afiliados/base.html' %}
{% load static %}

{% block content %}

<style>
.dashboard-wrapper {
    margin-left: 260px !important;
    padding: 25px;
}

.card-dashboard {
    padding: 30px;
    border-radius: 15px;
    background: #fff;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

/* üü¶ TARJETAS GLOBALES FIJAS */
.global-card {
    background: #eef2f7;
    border-radius: 8px;
    padding: 6px;
    text-align: center;
    margin: 3px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}
.global-card h6 {
    font-size: 10px;
    margin: 0;
    font-weight: 600;
    color: #333;
}
.global-card p {
    font-size: 15px;
    font-weight: bold;
    margin: 0;
    color: #2c3e50;
}

/* Conservar estilo original */
.chart-box {
    height: 380px;
}
.chart-box canvas {
    max-height: 380px !important;
}

.ranking-table {
    width: 100%;
    margin-top: 25px;
    border-collapse: collapse;
}
.ranking-table th {
    background: #343a40;
    color: white;
    padding: 10px;
}
.ranking-table td {
    padding: 9px;
    text-align: center;
    border-bottom: 1px solid #ddd;
    font-size: 15px;
}
.ranking-gold { background: #ffe08a; }
.ranking-silver { background: #e9ecef; }
.ranking-bronze { background: #ffd6a0; }

</style>

<div class="dashboard-wrapper">

    <div class="card card-dashboard">
<br><br><br>
<!-- üü¶ TARJETAS FIJAS (TOTALES MUNICIPALES) -->
<div class="d-flex flex-wrap justify-content-center mb-4">

    {% for partido, total in ranking_global %}
        <div class="global-card mx-2 my-1">
            <h6>{{ partido|upper }}</h6>
            <p>{{ total }}</p>
        </div>
    {% endfor %}

</div>

        <!-- FILTROS -->
        <div class="row mb-4">
            <div class="col-md-6">
                <label><b>Centro de Votaci√≥n:</b></label>
                <select id="selectCentro" class="form-control">
                    <option value="">Seleccione...</option>
                    {% for c in centros %}
                    <option value="{{ c }}">{{ c }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-6">
                <label><b>Mesa (opcional):</b></label>
                <select id="selectMesa" class="form-control">
                    <option value="">Seleccione un centro primero</option>
                </select>
            </div>
        </div>

        <!-- GR√ÅFICAS -->
        <div class="row mt-4">
            <div class="col-md-12 mb-4 chart-box">
                <canvas id="graficaPartidos"></canvas>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-md-6 mb-4 chart-box">
                <canvas id="graficaTorta"></canvas>
            </div>
            <div class="col-md-6 mb-4 chart-box">
                <canvas id="graficaRadar"></canvas>
            </div>
        </div>

        <!-- RANKING -->
        <h3 class="mt-4"><b>üèÜ Ranking de Partidos</b></h3>
        <table id="tablaRanking" class="ranking-table">
            <thead>
                <tr>
                    <th>Puesto</th>
                    <th>Partido</th>
                    <th>Votos</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
let chartPartidos, chartTorta, chartRadar;

// ====================   CARGAR DATOS   ====================
function cargarDatos() {

    const centro = document.getElementById("selectCentro").value;
    const mesa = document.getElementById("selectMesa").value;

    if (!centro) return;

    fetch(`/afiliados/dashboard/datos/?centro=${encodeURIComponent(centro)}&mesa=${mesa}`)
        .then(res => res.json())
        .then(data => {

            if (data.error) {
                alert("No hay datos para este centro.");
                return;
            }

            const selectMesa = document.getElementById("selectMesa");
            const mesaSeleccionada = selectMesa.value;

            selectMesa.innerHTML = `<option value="0">Todas</option>`;
            data.mesas.forEach(m => {
                selectMesa.innerHTML += `<option value="${m}">${m}</option>`;
            });

            selectMesa.value = mesaSeleccionada;

            actualizarGraficas(data);
            actualizarRanking(data.partidos);
            actualizarTotales(data.partidos);  // üü¶ NUEVO

        })
        .catch(error => console.log("Error:", error));
}

document.getElementById("selectCentro").addEventListener("change", cargarDatos);
document.getElementById("selectMesa").addEventListener("change", cargarDatos);


// ====================   TARJETAS GLOBALES (NUEVO)   ====================
function actualizarTotales(partidos) {

    const contenedor = document.getElementById("totalesGlobales");
    contenedor.innerHTML = "";

    Object.entries(partidos).forEach(([partido, votos]) => {
        contenedor.innerHTML += `
            <div class="col-md-2 col-sm-4 col-6">
                <div class="total-card">
                    <h6>${partido.toUpperCase()}</h6>
                    <p>${votos}</p>
                </div>
            </div>
        `;
    });
}


// ====================   GR√ÅFICAS   ====================
function actualizarGraficas(data) {

    const partidos = Object.keys(data.partidos);
    const valores = Object.values(data.partidos);

    const colores = partidos.map(() =>
        `hsl(${Math.floor(Math.random() * 360)}, 70%, 55%)`
    );

    if (chartPartidos) chartPartidos.destroy();
    chartPartidos = new Chart(document.getElementById("graficaPartidos"), {
        type: "bar",
        data: { labels: partidos, datasets: [{ label: "Votos por partido", data: valores, backgroundColor: colores }] },
        options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });

    if (chartTorta) chartTorta.destroy();
    chartTorta = new Chart(document.getElementById("graficaTorta"), {
        type: "pie",
        data: { labels: ["Blanco", "Nulos", "Inv√°lidos"],
                datasets: [{ data: [data.resumen.votos_blanco, data.resumen.votos_nulos, data.resumen.votos_invalidos],
                             backgroundColor: ["#999", "#d9534f", "#f0ad4e"] }] }
    });

    if (chartRadar) chartRadar.destroy();
    chartRadar = new Chart(document.getElementById("graficaRadar"), {
        type: "radar",
        data: { labels: partidos, datasets: [{ label: "Distribuci√≥n por partidos",
                                               data: valores, backgroundColor: "rgba(54,100,235,0.3)",
                                               borderColor: "rgba(54,100,235,1)" }] }
    });
}


// ====================   üèÜ RANKING   ====================
function actualizarRanking(partidos) {

    const tbody = document.querySelector("#tablaRanking tbody");
    tbody.innerHTML = "";

    const ranking = Object.entries(partidos)
        .map(([partido, votos]) => ({ partido, votos }))
        .sort((a, b) => b.votos - a.votos);

    ranking.forEach((item, index) => {

        let rowClass = "";
        if (index === 0) rowClass = "ranking-gold";
        else if (index === 1) rowClass = "ranking-silver";
        else if (index === 2) rowClass = "ranking-bronze";

        tbody.innerHTML += `
            <tr class="${rowClass}">
                <td><b>#${index + 1}</b></td>
                <td>${item.partido.toUpperCase()}</td>
                <td><b>${item.votos}</b></td>
            </tr>
        `;
    });
}

</script>

{% endblock %}
